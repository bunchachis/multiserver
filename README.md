# Multiserver

Пакет предназначен для быстрого разворачивания реверс-прокси.
В основе находится образ [jwilder/nginx-proxy](https://hub.docker.com/r/jwilder/nginx-proxy/),
который следит за тем, какие контейнеры Docker запускаются и останавливаются.

Если у запущенного контейнера заданы определённые переменные окружения,
то nginx-proxy автоматически начнёт перенаправлять на него
входящие http(s)-запросы, в которых указан соответствующий host.

Если в nginx-proxy добавлен SSL-сертификат на имя запрашиваемого
хоста, то он автоматически обернёт http трафик до контейнера в
https трафик до клиента.

## Установка
1. Скачайте репозиторий в отдельную папку, переместитесь в неё;
2. Скопируйте `.env.dist` в `.env` и отредактируйте его;
3. При необходимости скопируйте override-конфиг (см. «Сервисы для разработки»)
4. Выполните `docker network create multiserver`.
5. Если используете override-конфиг, выполните `docker network create multiserver_backend`.
6. Выполните `docker compose up -d`.

## Подключение контейнеров
Для подключения вашего контейнера к multiserver, укажите в нём
переменные окружения:
- `VIRTUAL_HOST` — имя хоста (доменное имя), запросы для которого должны
  отправляться в этот контейнер. Поддерживается перечисление через 
  запятую и/или указание wildcard (*.example.com) и regex;
- `VIRTUAL_PORT` (опционально, по умолчанию 80) — номер порта, на котором
  находится веб-сервер в этом контейнере;
- `HTTPS_METHOD` (опционально, по умолчанию 'redirect') — способ работы с https:
  - `redirect` — входящие http переадресуются на https (при наличии сертификата),
  - `noredirect` — входящие http не переадресуются на https,
  - `nohttp` — доступен только https,
  - `nohttps` — доступен только http.


## Установка сертификатов
Нужные сертификат и ключ нужно скопировать в папку certs в корне проекта.
Они должны называться по имени хоста, и отличаться только расширением:
- `domain.name.crt` — сертификат (full-chain),
- `domain.name.key` — ключ сертификата.

Если устанавливается wildcard-сертификат, то он должен быть назван
по имени хоста, следующего после wildcard `*.`

## Stub
Контейнер `stub` используется для отображения страницы-заглушки если
nginx-proxy не обнаружил контейнера, соответствующего запрашиваему hostname.

## Сервисы для разработки
В `docker-compose.override.yml.dist` находятся дополнительные сервисы
для разработки, и сеть для них:
- mailcatcher — почтовый сервер-заглушка в веб-интерфейсом.

Если они нужны, скопируйте его в `docker-compose.override.yml`
и отредактируйте под свои нужды.
